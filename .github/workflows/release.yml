name: Release Build and Publish

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v5

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\cargo\registry
            ~\AppData\Local\cargo\git
            packages/xcap_ffi/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('packages/xcap_ffi/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: beta
          cache: true

      - name: Enable native assets
        run: flutter config --enable-native-assets

      - name: Install dependencies
        run: flutter pub get
        
      - name: Build Windows
        run: flutter build windows --release

      - name: Create Windows ZIP
        run: |
          Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath petto-windows-x64.zip

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: petto-windows-x64.zip
          retention-days: 1

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v5

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            packages/xcap_ffi/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('packages/xcap_ffi/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: beta
          cache: true

      - name: Enable native assets
        run: flutter config --enable-native-assets

      - name: Install dependencies
        run: flutter pub get

      - name: Create podfile
        run: flutter create --platforms=macos . && sed -i '' "s/^#* *platform :.*$/platform :osx, '10.15'/" macos/Podfile

      - name: Build macOS
        run: flutter build macos --release

      - name: Create macOS DMG
        run: |
          # Create a temporary directory for DMG creation
          mkdir -p build/dmg
          cp -R build/macos/Build/Products/Release/petto.app build/dmg/
          
          # Create DMG using hdiutil
          hdiutil create -volname "Petto" -srcfolder build/dmg -ov -format UDBZ petto-macos.dmg

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-release
          path: petto-macos.dmg
          retention-days: 1

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v5

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            packages/xcap_ffi/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('packages/xcap_ffi/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            git \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            libstdc++-12-dev

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: beta
          cache: true

      - name: Enable native assets
        run: flutter config --enable-native-assets

      - name: Install dependencies
        run: flutter pub get

      - name: Build Linux
        run: flutter build linux --release

      - name: Create Linux AppImage
        run: |
          # Install AppImage tools
          sudo apt-get install -y libfuse2
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          
          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          # Copy application files
          cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/
          
          # Create desktop file
          cat > AppDir/usr/share/applications/petto.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=Petto
          Exec=petto
          Icon=petto
          Categories=Utility;
          EOF
          
          # Create AppRun script
          cat > AppDir/AppRun <<EOF
          #!/bin/bash
          HERE="\$(dirname "\$(readlink -f "\${0}")")"
          exec "\${HERE}/usr/bin/petto" "\$@"
          EOF
          chmod +x AppDir/AppRun
          
          # Copy icon from macOS assets
          cp macos/Runner/Assets.xcassets/AppIcon.appiconset/app_icon_256.png AppDir/usr/share/icons/hicolor/256x256/apps/petto.png
          
          # Create AppImage
          ./appimagetool-x86_64.AppImage AppDir petto-linux-x86_64.AppImage

      - name: Create Linux tar.gz
        run: |
          tar -czf petto-linux-x86_64.tar.gz -C build/linux/x64/release/bundle .

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-release
          path: |
            petto-linux-x86_64.AppImage
            petto-linux-x86_64.tar.gz
          retention-days: 1

  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Clone repository
        uses: actions/checkout@v5

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.tag_name }}" >> $GITHUB_ENV
            echo "version=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: Petto ${{ steps.get_version.outputs.version }}
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.version, '-beta') || contains(steps.get_version.outputs.version, '-alpha') }}
          files: |
            artifacts/windows-release/petto-windows-x64.zip
            artifacts/macos-release/petto-macos.dmg
            artifacts/linux-release/petto-linux-x86_64.AppImage
            artifacts/linux-release/petto-linux-x86_64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest release badge
        if: success() && !contains(steps.get_version.outputs.version, '-beta') && !contains(steps.get_version.outputs.version, '-alpha')
        run: |
          echo "Release ${{ steps.get_version.outputs.version }} has been published successfully!"
          echo "Download links:"
          echo "- Windows: https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.version }}/petto-windows-x64.zip"
          echo "- macOS: https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.version }}/petto-macos.dmg"
          echo "- Linux AppImage: https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.version }}/petto-linux-x86_64.AppImage"
          echo "- Linux tar.gz: https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.version }}/petto-linux-x86_64.tar.gz"