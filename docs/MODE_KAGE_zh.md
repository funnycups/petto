# Kage模式使用指南

Kage模式是v3.0.0起的默认桌宠渲染与交互方式，提供了一种有别于Live2DViewerEX的渲染方案。
Kage是一款自由及开放源代码软件，你可以在[Kage仓库](https://github.com/funnycups/kage)中提交问题、做出贡献或审查源代码。

## 1. 首次运行&自动下载
1. 直接启动Petto(首次会默认选择Kage模式)
2. 如果未配置`kage_executable`且本地未运行Kage：
   * Petto会提示下载最新[Release](https://github.com/funnycups/kage/releases/latest)
3. 解压后会记录可执行文件路径，后续直接启动。

> 若你已手动安装Kage，可在设置中直接选择其可执行文件，并设定模型JSON路径。

## 2. 设置项说明
在设置→模式选择`Kage`后会出现以下字段：

### Kage可执行文件

指向Kage的可执行文件路径。支持：
* Windows: `kage.exe`
* macOS: `Kage.app`
* Linux: `kage`

示例：`C:\Users\You\.petto\kage\kage.exe`

如果留空且Kage未运行，Petto会在启动时提示下载。

### 模型配置路径

Kage模型的JSON文件路径。

示例：`C:\models\hiyori.model3.json`

### Kage API地址

Kage的WebSocket服务地址。

默认：`ws://localhost:23333`

如果修改了Kage的启动端口，需要同步修改此地址。

### 动作分组

桌宠可用的动作列表，用逗号分隔。

示例：`Idle,Tap,TapHead`

**获取方式：**
1. 点击右侧刷新图标
2. Petto会自动从Kage获取当前模型的所有动作
3. 自动填充到此字段

也可以手动填写，但需确保动作名称与模型中的一致。

## 3. 模型加载与切换

### 首次加载
1. 在"模型配置路径"中填写模型JSON文件的完整路径
2. 点击保存
3. Petto会自动通过WebSocket发送模型路径给Kage
4. Kage加载完成后，可点击动作分组的刷新按钮获取动作列表

### 切换模型
1. 选择新的模型JSON路径
2. 点击保存
3. Kage会自动卸载旧模型并加载新模型

## 4. 动作与表情

Kage支持以下功能：
* **触发动作**：在定时问候、语音回应时自动触发动作分组中的随机动作
* **查询动作列表**：通过刷新按钮获取当前模型的所有可用动作
* **设置表情**：支持长期表情设置(需模型支持)
* **清除表情**：恢复到默认表情

动作会在以下场景自动触发：
* 定时问候
* 语音识别后的回复
* 用户发送消息时

## 5. 常见问题

### 无法连接Kage
**可能原因：**
* Kage未启动
* WebSocket地址不正确
* 防火墙拦截
* 端口被其他程序占用

**解决办法：**
1. 确认Kage是否正在运行
2. 检查地址是否为Kage中配置的地址(默认为`ws://localhost:23333`)
3. 检查防火墙设置，允许Petto和Kage通信
4. 如果端口被占用，可以修改Kage的启动参数，然后同步修改Petto设置中的地址

### 动作/表情列表为空
**可能原因：**
* 模型JSON路径不正确
* 模型文件损坏
* 模型格式不支持

**解决办法：**
1. 确认模型JSON文件路径正确且文件存在
2. 尝试在Kage中单独加载该模型，查看是否有错误提示

## 6. 日志排查

启用设置→启用日志后，可以查看详细的日志信息。

日志文件可以帮助快速定位问题，建议在遇到问题时先启用日志功能。
